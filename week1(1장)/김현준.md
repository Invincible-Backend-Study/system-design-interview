## 단일 서버

- 웹, 앱, 데이터베이스, 캐시 등이 전부 한 대에서 실행되는 모습

## 데이터베이스

- 사용자가 늘면 서버 하나로는 충분하지 않게된다.
- 웹/모바일 트래픽 처리 용도 웹 서버 1대, 데이터베이스용 1대로 분리한다.
    - 각각을 독립적으로 확장 가능

### RDB VS NoSQL

- RDB: 자료를 테이블과 열, 칼럼으로 표현한다.
    - SQL을 사용해 여러 테이블에 있는 데이터를 그 관계에 따라 조인하여 합칠 수 있다.
- NoSQL: 비 관계형 데이터베이스
    - key-value 저장소, 그래프 저장소, 칼럼 저장소, document 저장소로 나뉜다.
    - 아주 낮은 응답 지연시간이 요구 될 때
    - 다루는 데이터가 비정형일 때
    - 데이터를 직렬화하거나 역직렬화 할 수 있기만 하면 될 때
    - 많은 양의 데이터를 저장할 필요가 있을 때

| 특징 | RDB | NoSQL |
| --- | --- | --- |
| **데이터 모델** | 테이블 기반 (행과 열 구조) | Key-Value, Document, Column Family, Graph 모델 등 |
| **스키마** | 고정된 스키마 (Schema) | 스키마리스 (Schema-less) |
| **확장성** | 수직적 확장 (Scale-Up) | 수평적 확장 (Scale-Out) → 자동 지원 |
| **일관성 모델** | ACID 트랜잭션 (강한 일관성) | BASE 모델 (최종적 일관성 보장 모든 노드가 일정 시간이 지나면 일관된 상태) 
(Basically Available, Soft state, Eventually consistent) |
| **처리 속도** | 복잡한 조인과 쿼리 가능, 다소 느림 | 단순한 읽기와 쓰기에 매우 빠름 |
| **사용 사례** | 금융, ERP, 재고 관리 등 관계형 데이터가 필요한 경우 | 소셜 미디어, 로그 분석, 비정형 데이터 저장 등에 적합 |

## 수직적 규모 확장 vs 수평적 규모 확장

- 수직적 규모 확장(Scale up)에는 한계가 있다. → 무한대로 증설할 방법은 없음.
- Scale Up은 장애에 대한 자동복구(failover) 방안이나 다중화 방안을 제시하지 않는다.(SPOF)

### 로드밸런서(웹 서버의 Scale Out)

- 부하 분산 집합에 속한 서버들에게 트래픽 부하를 고르게 분산하는 역할
- 사용자는 로드밸런서의 공개 IP 주소로 접속하고 로드밸런스는 웹서버와 사설 IP 주소로 통신
- 로드밸런서의 추가로 웹서버를 여러대 둘 수 있음
    - 서버가 다운되면 자동으로 트래픽을 다운이 되지 않은 서버로 전송 가능

### 데이터베이스 다중화

- 서버 사이에 Master - Slave 관계 설정
    - 데이터 원본은 Master에 사본은 부 서버에 저장하는 방식
- 쓰기 연산은 마스터에서만 지원하고 슬레이브에선 마스터에게 사본을 전달받아 읽기 연산만을 지원
    - insert, delete, update 등은 주 데이터베이스로만 전달되어야 함.
- Query 병렬 처리 가능, SPOF 개선
- 마스터 다운 시 슬레이브가 승격해서 새로운 주 서버로 수행 가능
    - 다만 최신 상태가 아닐 수 있어서 복구 스크립트 실행해야 할 가능성 있음

## 캐시

- 캐시 계층을 두면 성능 개선 및 데이터베이스 부하를 줄일 수 있음.
- 대표적인 예: 읽기 주도형 캐시 전략(Read Through) → 캐시에서만 데이터를 읽어오는 전략
    - 웹 서버가 캐시에 응답이 저장되어 있는지 확인
    - 있다면 데이터 반환, 없다면 라이브러리 또는 캐시 제공자에게 위임해 DB에게 쿼리를 보내 데이터를 찾아 캐시에 저장한 후 반환
- 이외의 예
    - 읽기 주도형 캐시 전략
        - Look Aside → 캐시 우선 확인, 없으면 DB 조회 후 서버가 캐시에 데이터를 갱신
    - 캐시 쓰기 전략
        - Write Back → 데이터를 저장할 때 DB에 바로 쿼리하지 않고, 캐시에 모아서 일정 주기 배치 작업을 통해 DB에 반영(비동기)
        - Write Through → 데이터를 저장할 때 먼저 캐시에 저장한 다음 바로 DB에 저장(캐시 최신 상태 유지, 매 요청마다 두번의 Write 발생)
        - Write Around → 모든 데이터는 DB에 저장(캐시 갱신 X), Cache miss 발생하는 경우에만 DB와 캐시에 데이터를 저장, 따라서 캐시와 DB의 데이터가 다를 수 있음.
- 유의할 점
    - 데이터 갱신은 자주 일어나지 않고 참조는 자주 일어날 경우 도입
    - 어떤 데이터를 두어야 할지
    - 캐시에 보관된 데이터를 적절한 시기에 만료
    - 일관성 유지 → 원본과 사본의 동기화
    - 장애 대처
    - 캐시 메모리의 사이즈 → 작으면 캐시가 밀려버려 성능 떨어짐
    - 데이터 방출 정책 → 어떤 캐시 방출 정책을 사용할 것 인지

## 콘텐츠 전송 네트워크(CDN)

- 정적 콘텐츠 전송에 쓰이는, 지리적으로 분산된 서버의 네트워크 → 이미지나 비디오 CSS, JS 파일등을 캐시 가능
- 동적 콘텐츠 캐시는 요청 경로, 쿼리, 쿠키, 헤더를 기반하여 HTML 페이지 캐싱
- CDN의 동작 과정
    - 사용자 웹사이트 접속
    - 가까운 CDN 서버가 콘텐츠 전송
        - 없다면 서버에서 가져와서 반환
- 유의할 점
    - 비용 → 데이터 전송 양에 따라 요금 부과
    - 적절한 시기에 만료
    - CDN 장애 대처
    - 콘텐츠 무효화

## 무상태 웹 계층

- 웹 계층을 수평적으로 확장하기 위해서는 상태 정보(사용자 세션 데이터와 같은)를 웹 계층에서 제거
- 상태 정보는 DB와 같은 지속성 저장소에 보관하고 필요할 때 가져오도록 하는 것
    - 만약 상태 정보 유지 시 같은 클라이언트가 항상 같은 서버와 통신해야됨
    - 로드밸런서가 이를 지원하기 위해 sticky session이라는 기능을 제공하지만 로드밸런서에 부담을 줌
        - 세션 유지, 한 쪽으로 트래픽 몰림, 인스턴스 추가해도 기존 세션을 새로운 인스턴스에 전달하지 못함, …

### 무상태 아키텍처

- 서버가 상태 정보가 필요한 경우 공유 저장소로부터 데이터를 가져온다.
    - 단순하고 안정적이며, 규모 확장이 쉽다.

## 데이터 센터

- 지리적 라우팅을 통해 가까운 데이터 센터로 보냄
- geoDNS는 사용자의 위치에 따라 도메인 이름을 어떤 IP 주소로 변환할지 결정
- 장애 발생 시 장애가 없는 데이터 센터로 전송
- 생각 해볼 점
    - 트래픽 우회 → 트래픽을 올바른 데이터 센터로 보내는 방법
    - 데이터 동기화 → 다른 데이터베이스 우회 시 찾는 데이터가 없을 수 있음. → 메시지 큐 등의 이벤트 기반 데이터 동기화 가능
    - 테스트와 배포

## 메시지 큐

- 메시지의 무손실(보관된 메시지는 소비자가 꺼낼 때까지 안전히 보관된다는 특성)을 보장하는, 비동기 통신을 지원하는 컴포넌트
- 메시지의 버퍼 역할을 하며, 비동기적으로 전송
- 생산자 또는 발행자라고 불리는 입력 서비스가 메시지를 만들어 큐에 발행
- 소비자 또는 구독자라고 불리는 서버가 메시지를 받아 그에 맞는 동작 수행
- 결합이 느슨해져 생산자는 소비자 프로세스가 다운되어 있어도 메시지 발행 가능, 반대의 경우에도 소비자는 메시지 수신 가능

## 데이터베이스의 규모 확장

### Scale Up

- 고성능의 자원을 증설하는 방법
    - SPOF 위험, 비용 증가, 한계 존재

### Scale Out

- 샤딩이라고 부르고 샤드라고 부르는 작은 단위로 분할하는 기술
- 모든 샤드는 같은 스키마를 쓰지만 샤드에 보관되는 데이터 사이에는 중복이 없음
- 샤딩 전략를 구현할 때 샤딩 키를 어떻게 정하는지 중요(파티션 키)
    - 데이터의 재샤딩
        - 데이터가 너무 많아져서 하나의 샤드로는 더 이상 감당하기 어려울 때, 샤드 간 데이터 분포가 균등하지 못해 어떤 샤드가 다른 샤드에 비해 빨리 소진 될 때 샤드 키를 계산하는 함수를 변경하고 데이터를 재배치 해야함
    - 유명인사 문제(핫스팟 키)
        - 특정 샤드에 쿼리가 집중되어 서버에 과부하가 걸리는 문제
    - 조인과 비정규화
        - 여러 샤드에 걸친 데이터를 조인하기가 힘들어짐
        - 비정규화하여 하나의 테이블에서 질의가 수행될 수 있도록 할 수 있음
